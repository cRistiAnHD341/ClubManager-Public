## v{{Version}} ({{Date}})

Novedades destacadas

**Control de Acceso: Sistema Arduino auto-detectable con reconexión inteligente**
- Detección automática de Arduino sin COM fijo preestablecido.
- Escaneo completo de puertos serie con heurística WMI (Arduino / CH340 / FTDI / CP210x / USB-SERIAL).
- Handshake multi-baud automático (115200, 9600, 57600) con selección del primer dispositivo válido.
- Soporte multi-Arduino: ComboBox en cabecera para elegir entre varios dispositivos y botón "Conectar".
- Reconexión automática al iniciar partido: garantiza que Arduino esté listo antes de registrar accesos.
- Botón permanente "🔌 Arduino" para re-escanear y reconectar en caliente durante el partido.

**Historial de Accesos Individual por Abonado**
- Nueva ventana dedicada "🎫 Historial de Accesos" accesible desde botón en lista de Abonados.
- Visualización de partidos únicos asistidos (si entró 12 veces al mismo partido cuenta como 1).
- Estadísticas en tiempo real:
  - Total de partidos únicos asistidos.
  - Porcentaje de asistencia sobre partidos finalizados de la temporada.
  - Desglose partidos como local / como visitante.
- Columnas detalladas: fecha partido, rival, competición, jornada, resultado, estado, primer acceso, total de accesos, método.
- Filtros por equipo (busca en local/visitante/competición) y checkbox "Solo finalizados".
- Diseño coherente con estilos ModernDataGrid, HeaderBackgroundBrush y paleta de colores global.

**Flujo Integrado: Guardar y Grabar NFC**
- Nuevo botón "💾📱 Guardar y Grabar NFC" en ventana de edición de Abonados (AbonadoEditWindow).
- Flujo automático: guarda datos del abonado → abre ventana NFC con datos precargados → usuario acerca tarjeta y graba.
- Elimina pasos manuales: no es necesario buscar al abonado después de guardarlo.
- Confirma guardado antes de abrir ventana NFC; si falla el guardado, no se abre NFC.

**Sesión de Usuario Unificada (Models)**
- Migración completa a UserSession en Models (elimina dependencia de versión Services duplicada).
- Cálculo dinámico de EsAdministrador basado en:
  - Rol (Administrador / SuperAdministrador).
  - Permisos granulares (CanConfigureControlAcceso*, CanManagePartidos, CanAccessUsuarios).
- Actualización automática vía INotifyPropertyChanged al cambiar CurrentUser o CurrentPermissions.
- Desuscripción correcta en Dispose para evitar fugas de memoria.

**NFC Writer: Mejora en campos predeterminados**
- Campo "Código de Barras" ahora preseleccionado por defecto (IsSelected = true) en abonados estándar.
- Facilita escritura rápida de datos esenciales sin configuración manual.
- Mantiene flexibilidad para deseleccionar si no se necesita.

Mejoras

**Control de Acceso Arduino**
- Handshake más robusto: limpieza de buffer + envío "PING" tras "ARDUINO_READY" / "PONG".
- Reintento automático en loop si puerto se desconecta (corte de cable) sin reiniciar ventana.
- Método ScanArduinoCandidatesAsync reutilizable para futuras herramientas de diagnóstico.
- Heurística de priorización: primero puertos con descripciones coincidentes (palabras clave: arduino, ch340, ftdi), luego orden alfabético.
- Handshake acepta múltiples tokens: ARDUINO_READY | PONG | CODE:... (firmware flexible).
- Nueva clase ArduinoDeviceInfo con binding completo (Port, Baud, Description, IsSelected).

**Historial de Accesos**
- Agrupación inteligente: registros repetidos del mismo partido se condensan en 1 fila con contador.
- Columna "🔄 Accesos" muestra "1 acceso" o "N accesos" según repeticiones.
- Cálculo preciso de % asistencia: solo cuenta partidos finalizados de la temporada.
- Identificación equipo propio desde tabla Equipos (EsEquipoPropio) para cálculo local/visitante.
- Constructor sobrecargado: soporta tanto Abonado como AbonadoGeneral con parámetro booleano `esGeneral`.

**Edición de Abonados**
- Validación asíncrona mejorada (DNI duplicado, número socio único).
- Generación automática de código de barras único al crear nuevo abonado.
- Botón de regeneración manual de código de barras preservado.
- Flujo SaveAndWriteNfcAsync reutiliza lógica de SaveAbonadoAsync sin duplicar código.
- Refresco completo de entidad con Include antes de abrir NFC (evita datos incompletos).

**Lógica de Permisos**
- Fallback inteligente: si no cumple rol base, evalúa permisos granulares de UserPermissions.
- Permite escenarios donde un Gestor tiene permisos avanzados sin ser Administrador formal.

Correcciones

**Control de Acceso**
- Eliminado uso de UserSession duplicada (Services vs Models) que provocaba CS1061 (propiedades no encontradas).
- Limpieza correcta de suscripción PropertyChanged en Dispose.
- Reconexión Arduino al iniciar partido: evita estado "conectado pero sin handshake" que impedía procesar códigos.
- Protección contra múltiples ejecuciones simultáneas de AutoDetectArduinoAsync (_autoDetectingArduino).

**Historial de Accesos**
- Evitada cuenta duplicada de mismo partido: GroupBy por PartidoId antes de contar.
- Texto coherente en StatusBar: "partidos" en lugar de "accesos" para claridad.
- Manejo correcto de partidos sin equipo propio definido (retorna 0 en local/visitante).

**NFC Writer**
- Campo CodigoBarras marcado como preseleccionado para acelerar flujo estándar.
- Validación de existencia de Abonado vs AbonadoGeneral en constructores para evitar NullReferenceException.

Notas técnicas

**Arduino**
- Escaneo WMI opcional (Win32_SerialPort); si falla (Linux/Mac o permisos), continúa con SerialPort.GetPortNames().
- Timeout de handshake: 3 segundos para soportar Arduinos lentos (ej. reset por DTR).
- ReadLineAsync con .NET 9: lectura asíncrona real vía BaseStream.ReadAsync en lugar de bloqueo sincrónico.
- Tokens centralizados como constantes (ArduinoReadyToken, ArduinoPongToken, ArduinoCodePrefix).
- No se persiste selección de puerto entre sesiones (diseño intencionado para evitar errores si cambia hardware).

**Historial de Accesos**
- Agrupación LINQ eficiente:
- Cálculo % asistencia: solo considera partidos con Estado = Finalizado para evitar inflar denominador.

**Flujo Guardar y Grabar NFC**
- Secuencia atómica: save → refresh con Include → abrir NFC → evento SaveCompleted.
- Manejo de errores DbUpdateException para conflictos de concurrencia.
- Owner de ventana NFC fijado a Application.Current.MainWindow para evitar que quede detrás.

**Sesión de Usuario**
- PropertyChanged de UserSession en Models dispara UpdateEsAdministrador() reactivamente.
- Múltiples criterios de admin evaluados en OR lógico (rol base || permisos avanzados).

Cómo usar (guía rápida)

**1) Conectar Arduino automáticamente**
- Abrir Control de Acceso → escaneo automático al cargar ventana.
- Si detecta varios Arduinos: aparecen en ComboBox superior → seleccionar → "Conectar".
- Verificar indicador en cabecera (🟢 Puerto COM* @baud).

**2) Iniciar partido con Arduino**
- Seleccionar temporada y partido.
- Pulsar "▶️ Iniciar Partido" → reconexión automática Arduino en background.
- Esperar mensaje "Partido iniciado -Arduino listo en COM*".
- Pasar tarjeta NFC o código de barras → registro inmediato.

**3) Re-escanear Arduino en caliente**
- Si Arduino se desconecta durante partido: pulsar "🔌 Arduino".
- No interrumpe registro de accesos NFC.
- Útil si se cambia cable USB o puerto físico.

**4) Ver historial de accesos de un abonado**
-Ir a "Abonados" → localizar abonado → botón "🎫".
- Se abre ventana con partidos únicos, estadísticas y filtros.
- Cerrar ventana: datos se actualizan en tiempo real si hay cambios.

**5) Crearabonado y grabar NFC de inmediato**
- "➕ Nuevo Abonado" → rellenar formulario.
- Pulsar "💾📱 Guardar y Grabar NFC" (en lugar de "Guardar" solo).
- Confirmar datos → seabre ventana NFC con datos del abonado recién guardado.
- Acercar tarjeta → "Escribir" → verificación automática.

**6) Inyectar código de prueba (admin)**
- Abrir Control de Acceso→ panel "Modo Pruebas" (visible solo admin).
- Escribir código en "Código de barras prueba" → "Inyectar".
- Arduino procesa como si viniera del lector físico (útil para testing).

**7) Ajustar permisos de visualización**
- Cambiar usuario → EsAdministrador se recalcula automáticamente.
- Panel Arduino / Modo Pruebas aparece/desaparece según permisos.

Requisitos

- .NET 9• Windows (WPF)
- NuGet: System.Management (para detección WMI de puertos serie)
- Hardware: Arduino compatible (UNO, Nano, Mega) con sketch de lectura de códigos de barras
- Lector NFC ACR122U (opcional, para funciones NFC)

Próximos pasos sugeridos

- Persistir último puerto/baud exitoso en ConfiguracionControlAcceso (optimiza arranque).
- Añadir métrica de latencia por puerto para priorizar conexiones más estables.
- Gráfico de asistencia mensual en ventana de historial individual.
- Exportar historial a CSV/Excel conbotón funcional (actualmente placeholder).
- Log detallado de conexión Arduino en pestaña de diagnóstico (opcional).
- Modo "Solo lectura" para operadores sin acceso a pruebas Arduino.
- Notificación visual si Arduino se desconecta durante partido activo (toast/badge).
