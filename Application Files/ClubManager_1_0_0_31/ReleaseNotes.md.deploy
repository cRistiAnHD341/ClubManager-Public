## v{{Version}} ({{Date}})

### Novedades destacadas

**🤖 Control de Acceso: Arduino Auto-detectable con Reconexión Inteligente**
- Detección automática de Arduino sin necesidad de configurar puerto COM manualmente.
- Escaneo completo de puertos serie con heurística inteligente vía WMI (Arduino / CH340 / FTDI / CP210x / USB-SERIAL).
- Handshake multi-baud automático (115200, 9600, 57600) probando cada velocidad hasta encontrar respuesta.
- **Reconexión automática al iniciar partido**: garantiza que Arduino esté listo y sincronizado antes de registrar accesos.
- Soporte multi-Arduino: ComboBox en cabecera para seleccionar entre varios dispositivos conectados simultáneamente.
- Botón permanente "🔌 Arduino" para re-escanear y reconectar en caliente sin detener el registro de accesos.
- Sistema tolerante a desconexiones: reconecta automáticamente si se desenchufa el cable USB durante el partido.

**🔌 Modo Offline con Sincronización Diferida**
- **Sistema de caché local inteligente**: al iniciar partido, carga en memoria todos los abonados activos, entradas y configuraciones.
- **Detección automática de desconexión**: timer cada 5 segundos verifica conexión a BD con timeout de 2 segundos.
- **Validación instantánea sin bloqueos**: procesa códigos de barras/NFC usando caché local cuando no hay conexión.
- **Cola de sincronización diferida**: guarda registros pendientes en Queue thread-safe hasta restaurar conexión.
- **Sincronización automática inteligente**: 
  - Al detectar conexión restaurada, envía todos los registros pendientes a BD.
  - Evita duplicados verificando existencia previa (PartidoId + AbonadoId/EntradaId + FechaAcceso).
  - Marca entradas como usadas en BD si aplica control de doble acceso.
- **Indicadores visuales en tiempo real**:
  - 🔴 MODO OFFLINE / 🟢 CONECTADO en cabecera.
  - Contador "📋 Pendientes: N" visible solo en modo offline.
  - Texto "[OFFLINE]" en último acceso registrado.
- **Sin pérdida de datos**: los registros quedan en cola local hasta completar sincronización exitosa.
- **Continuidad operativa**: Arduino y NFC siguen funcionando normalmente durante pérdida de conexión.

**🎫 Historial de Accesos Individual por Abonado**
- Nueva ventana dedicada accesible desde botón "🎫" en la lista de Abonados.
- Visualiza partidos únicos asistidos: si un abonado entra 12 veces al mismo partido, cuenta como 1 partido con "12 accesos".
- **Estadísticas en tiempo real:**
  - Total de partidos únicos asistidos en la temporada.
  - Porcentaje de asistencia calculado sobre partidos finalizados.
  - Desglose partidos como local / como visitante (detecta equipo propio automáticamente).
- **Columnas detalladas:**
  - Fecha del partido, rival, competición, jornada.
  - Resultado final (marcador si disponible).
  - Estado del partido (Programado / En Juego / Finalizado / Suspendido con colores).
  - Primer acceso y último acceso registrados.
  - Total de accesos al mismo partido (columna "🔄 Accesos").
  - Método de acceso (NFC / Manual / Arduino).
- Filtros: por equipo (busca en local/visitante/competición) y checkbox "Solo finalizados".
- Diseño coherente con paleta global (ModernDataGrid, HeaderBackgroundBrush, estilos Success/Info/Warning/Accent).

**💾📱 Flujo Integrado: Guardar y Grabar NFC**
- Nuevo botón "💾📱 Guardar y Grabar NFC" en ventana de edición de Abonados.
- **Flujo automático completo:**
  1. Valida y guarda datos del abonado en base de datos.
  2. Refresca entidad con todos los Include necesarios (TipoAbono, Gestor, Peña).
  3. Abre automáticamente ventana NFC con datos del abonado recién guardado.
  4. Usuario acerca tarjeta NFC y pulsa "Escribir".
  5. Invoca evento SaveCompleted tras cerrar ventana NFC.
- Elimina pasos manuales: no es necesario buscar al abonado después de guardarlo.
- Valida guardado antes de abrir NFC: si falla, no abre la ventana de programación.
- Owner de ventana NFC fijado a MainWindow para evitar que quede detrás de otras ventanas.

**🔐 Sesión de Usuario Unificada (Models)**
- Migración completa a `UserSession` en Models (eliminada dependencia de versión duplicada en Services).
- Cálculo dinámico de `EsAdministrador` con doble criterio:
  - **Rol base:** Administrador o SuperAdministrador.
  - **Permisos granulares:** CanConfigureControlAcceso / CanConfigureControlAccesoAvanzado / CanAccessControlAccesoAvanzado / CanManagePartidos / CanAccessUsuarios.
- Actualización automática reactiva vía INotifyPropertyChanged al cambiar CurrentUser o CurrentPermissions.
- Suscripción PropertyChanged correcta en InitSession con desuscripción en Dispose (evita fugas de memoria).
- Panel "Modo Pruebas" en Control de Acceso visible solo para administradores (binding a EsAdministrador).

**🔖 NFC Writer: Campo Código de Barras Preseleccionado**
- Campo "Código de Barras" ahora viene marcado por defecto (IsSelected = true) al abrir ventana NFC.
- Acelera flujo estándar: grabación rápida sin configuración manual de campos.
- Mantiene flexibilidad: se puede deseleccionar si no se necesita en tarjeta.

**📅 Nueva Temporada: Preservación de Fecha de Creación Original**
- Al copiar abonados entre temporadas, ahora se mantiene la `FechaCreacion` original del abonado.
- Permite trazabilidad histórica: saber cuándo se dio de alta el socio por primera vez en el club.
- Útil para estadísticas de fidelización y antigüedad real del abonado.
- Cambio en línea: `FechaCreacion = DateTime.SpecifyKind(abonado.FechaCreacion, DateTimeKind.Utc)`.

### Mejoras

**Arduino**
- Handshake robusto: limpieza de buffer + envío "PING" tras recibir "ARDUINO_READY".
- Tokens centralizados como constantes (ArduinoReadyToken, ArduinoPongToken, ArduinoCodePrefix).
- ReadLineAsync con .NET 9: lectura asíncrona real vía BaseStream.ReadAsync en lugar de bloqueo sincrónico.
- Timeout de handshake ampliado a 3 segundos para soportar Arduinos con reset lento por DTR.
- Protección contra ejecuciones simultáneas de AutoDetectArduinoAsync (_autoDetectingArduino flag).
- Método ScanArduinoCandidatesAsync reutilizable para futuras herramienas de diagnóstico.

**Historial de Accesos**
- Agrupación LINQ eficiente:.GroupBy(r => r.PartidoId) .Select(g => new AccesoPartidoItem { TotalAccesos = g.Count(), FechaPrimerAcceso = g.Min(r => r.FechaAcceso), FechaUltimoAcceso = g.Max(r => r.FechaAcceso) })
- Cálculo % asistencia: solo considera partidos con `Estado = Finalizado` (evita inflar denominador con partidos suspendidos/programados).
- Identificación automática de equipo propio desde tabla Equipos (campo EsEquipoPropio).
- Constructor sobrecargado: soporta tanto Abonado como AbonadoGeneral con parámetro booleano `esGeneral`.
- Texto coherente en StatusBar: "partidos" en lugar de "accesos" para claridad semántica.

**Edición de Abonados**
- Flujo `SaveAndWriteNfcAsync` reutiliza lógica de `SaveAbonadoAsync` sin duplicar código.
- Validación asíncrona completa antes de abrir ventana NFC (DNI duplicado, número socio único).
- Refresco completo de entidad con Include antes de pasar a NFC (evita datos incompletos en ventana de programación).
- Generación automática de código de barras único al crear nuevo abonado.

**Permisos y Sesión**
- Fallback inteligente: si usuario no cumple rol base, evalúa permisos granulares de UserPermissions.
- Permite escenarios donde un Gestor tiene permisos avanzados sin ser Administrador formal.
- Session_PropertyChanged reactivo: actualiza UI automáticamente alcambiar usuario logueado.

### Correcciones

**Control de Acceso**
- Eliminado uso de UserSession duplicada (Services vs Models) que provocaba errores CS1061 (propiedades CanAdmin/CanSAdmin/eventos UserLoggedIn/UserLoggedOut no encontradas).
- Limpieza correcta de suscripción PropertyChanged en Dispose (evita fugas de memoria).
- **Reconexión Arduino al iniciar partido:** evita estado "conectado pero sin handshake" que impedía procesar códigos de barras.
- Protección contra doble procesamiento de misma tarjeta NFC en ventana pequeña de tiempo.

**Historial de Accesos**
- Evitada cuenta duplicada de mismo partido: GroupBy por PartidoId antes de mostrar.
- Manejo correcto de partidos sin equipo propio definido (retorna 0 encontadores local/visitante en lugar de exception).
- Binding correcto de ForegroundBrush en cabecera (era White hardcoded, ahora usa recurso dinámico).

**Nueva Temporada**
-**FechaCreacion preservada:** al copiar abonados se mantiene fecha original de alta en el club (antes se regeneraba con UtcNow).
- Evita pérdida de trazabilidad histórica de antigüedad delsocio.

### Notas técnicas

**Arduino**
- Escaneo WMI opcional (Win32_SerialPort); si falla (Linux/Mac o permisos insuficientes), continúa con SerialPort.GetPortNames().
- Heurística de priorización: primero puertos cuya descripción contiene palabras clave (arduino, ch340, ftdi), luego orden alfabético.
- Handshake acepta múltiples tokensválidos: ARDUINO_READY | PONG | CODE:... (firmware flexible).
- BaudCandidates centralizado en array estático para fácil modificación.
- No se persiste selección de puerto entresesiones (diseño intencionado para evitar errores si cambia hardware).

**Historial de Accesos**
- Modelo AccesoPartidoItem extendido con propiedades calculadas:
- `PartidoCompleto`: concatenación local vs visitante.
- `AccesosTexto`: pluralización inteligente ("1 acceso" vs "N accesos").
- `EstadoColor`: Brush según EstadoPartido.
- Constructor dual para Abonado y AbonadoGeneral sin duplicar ViewModel.

**Flujo Guardar y Grabar NFC**
- Secuencia atómica: save → refresh con Include → abrir NFC → evento SaveCompleted.
- Manejo específico de DbUpdateException para conflictos de concurrencia.
- Reutilización de validaciones (DNI, número socio) de SaveAbonadoAsync.

**Sesión de Usuario**
- PropertyChanged de UserSession.Instance dispara UpdateEsAdministrador() reactivamente.
- Evaluación en OR lógico: rol base || permisos avanzados (cualquiera activa EsAdministrador).
- Desuscripción en Dispose con try-catch para evitar excepciones al cerrar ventana.

**Nueva Temporada - FechaCreacion**
- Cambio de `DateTime.UtcNow` a `abonado.FechaCreacion` en copia de abonados.
- Permite consultas históricas: "abonados con más de 5 años de antigüedad".
- No afecta auditoría por temporada(campo TemporadaId ya existe para ese propósito).

### Cómo usar (guía rápida)

**1) Conectar Arduino automáticamente**
- Abrir Control de Acceso → escaneo automático al cargar ventana.
- Si detecta varios: aparecen en ComboBox superior → seleccionar → "Conectar".
- Verificar indicador verdeen cabecera (🟢 COM* @baud).

**2) Iniciar partido con Arduino**
- Seleccionar temporada y partido.
- Pulsar "▶️ Iniciar Partido" → reconexión automática Arduino+ handshake.
- Esperar mensaje "Partido iniciado - Arduino listo en COM*".
- Pasar tarjeta NFC o código de barras → registro inmediato con feedback visual.

**3) Re-escanear Arduino encaliente**
- Si Arduino se desconecta durante partido: pulsar "🔌 Arduino".
- No interrumpe registro de accesos NFC.
- Útil tras cambiar cable USB o puerto físico.

**4) Ver historial de accesos de un abonado**
- Ir a "Abonados" → localizar abonado → botón "🎫" (icono ticket).
- Se abre ventana con partidos únicos asistidos, estadísticas y filtros.
- Filtrar por equipo o marcar "Solo finalizados" para análisis específico.

**5) Crear abonado y grabar NFC de inmediato**
- "➕ Nuevo Abonado" → rellenar formulario completo.
- Pulsar "💾📱 Guardar y Grabar NFC" (en lugar de solo "Guardar").
- Confirmar datos → se abre ventana NFC con datos del abonado recién guardado.
- Acercar tarjeta → "Escribir" → verificación automática → cerrar.

**6) Inyectar código de prueba (admin)**
- Abrir Control de Acceso → panel "🛠️ Modo Pruebas" (visible solo admin).
- Escribir código en campo de prueba → "Inyectar".
- Arduino procesa como siviniera del lector físico (útil para testing sin hardware).

**7) Iniciar nueva temporada preservando antigüedad**
- Al copiar abonados entre temporadas, la fecha de creación original se mantiene.
- Permite consultar antigüedad real del socio en reportes históricos.

### Requisitos

- .NET 9 • Windows (WPF)
- **NuGet:** System.Management (para detección WMI de puertos serie)
- **Hardware opcional:**
- Arduino compatible (UNO, Nano, Mega) con sketch de lectura de códigos de barras.
- Lector NFC ACR122U (para funciones NFC).

### Próximos pasos sugeridos

- Persistir último puerto/baud exitoso en ConfiguracionControlAcceso (optimiza arranque).
- Gráfico de asistencia mensual en ventana de historial individual.
- Exportar historial a CSV/Excel con botón funcional (actualmente placeholder).
- Notificación visual toast si Arduino se desconecta durante partido activo.
- Modo "Solo lectura" para operadores sin acceso a pruebas Arduino.
- Logs detallados de conexión Arduino en pestaña de diagnóstico.